{% extends "base.html" %}
{% block title %}AI ì˜í™” ì¶”ì²œ ì±—ë´‡{% endblock %}

{% block content %}
<div class="chat-wrap">
  <div class="chat-card">
    <div class="chat-header">
      ğŸ¬ AI ì˜í™” ì¶”ì²œ ì±—ë´‡
    </div>

    <div class="chat-body">
      <div id="chatLog" class="chat-log"></div>

      <div class="chat-chips">
        <button class="chip" data-chip="ì•¡ì…˜ ì˜í™” ì¶”ì²œ">ì•¡ì…˜ ì˜í™” ì¶”ì²œ</button>
        <button class="chip" data-chip="ë¡œë§¨ìŠ¤ ì˜í™”">ë¡œë§¨ìŠ¤ ì˜í™”</button>
        <button class="chip" data-chip="ê³ í‰ì  ì˜í™”">ê³ í‰ì  ì˜í™”</button>
        <button class="chip" data-chip="ìµœê·¼ ì˜í™”">ìµœê·¼ ì˜í™”</button>
      </div>
    </div>

    <div class="chat-input">
      <input id="msg" type="text" placeholder="ì˜í™”ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”..." />
      <button id="send">ì „ì†¡</button>
    </div>
  </div>
</div>

<script>
  const chatLog = document.getElementById("chatLog");
  const msg = document.getElementById("msg");
  const send = document.getElementById("send");

  function addBubble(role, text) {
    const div = document.createElement("div");
    div.className = "bubble " + (role === "me" ? "me" : "bot");
    div.textContent = text;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
    return div;
  }

  function addIntro() {
    addBubble("bot", "ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ë‹¹ì‹ ì˜ ì˜í™” ë¦¬ë·°/ì»¬ë ‰ì…˜ì„ ë°”íƒ•ìœ¼ë¡œ ì˜í™”ë¥¼ ì¶”ì²œí•´ë“œë¦¬ëŠ” AIì…ë‹ˆë‹¤.\nì–´ë–¤ ì˜í™”ë¥¼ ì°¾ê³  ê³„ì‹ ê°€ìš”?");
  }

  async function sendMessage(text) {
    const t = (text || "").trim();
    if (!t) return;

    addBubble("me", t);
    msg.value = "";
    send.disabled = true;

    const loadingBubble = addBubble("bot", "ìƒì„± ì¤‘...");

    try {
      const res = await fetch("{% url 'chatbot:api' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ message: t }),
      });

      const data = await res.json();
      loadingBubble.textContent = data.answer || "(ì‘ë‹µ ì—†ìŒ)";
    } catch (e) {
      loadingBubble.textContent = "ì˜¤ë¥˜ê°€ ë‚¬ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    } finally {
      send.disabled = false;
      msg.focus();
    }
  }

  // ì—”í„° ì „ì†¡
  msg.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      sendMessage(msg.value);
    }
  });

  // ë²„íŠ¼ ì „ì†¡
  send.addEventListener("click", () => sendMessage(msg.value));

  // ì¹© í´ë¦­
  document.querySelectorAll(".chip").forEach(btn => {
    btn.addEventListener("click", () => sendMessage(btn.dataset.chip));
  });

  // ì²« ì¸ì‚¬
  addIntro();
</script>
{% endblock %}
