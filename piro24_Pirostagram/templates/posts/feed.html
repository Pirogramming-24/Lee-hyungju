<!-- templates/posts/feed.html -->
{% extends "base.html" %}
{% block title %}í”¼ë“œ{% endblock %}

{% block content %}
  <section class="card">
    <div class="card-header">
      <h2>ìŠ¤í† ë¦¬</h2>
      <a class="link" href="{% url 'posts:story_list' %}">ì „ì²´ë³´ê¸°</a>
    </div>

    {% if stories %}
      <div class="story-row">
        {% for s in stories %}
          <a class="story-bubble" href="{% url 'posts:story_detail' s.id %}">
            <div class="avatar">
              {% if s.author.profile_pic %}
                <img src="{{ s.author.profile_pic.url }}" alt="profile">
              {% else %}
                <div class="avatar-fallback"></div>
              {% endif %}
            </div>
            <div class="story-name">{{ s.author.username }}</div>
          </a>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </section>

  <section class="feed">
    <div class="card-header">
      <h2>í”¼ë“œ</h2>
    </div>
    <div class="feed-toolbar">
      <a class="chip {% if sort == 'recent' %}active{% endif %}" href="?sort=recent">ìµœì‹ </a>
      <a class="chip {% if sort == 'likes' %}active{% endif %}" href="?sort=likes">ì¢‹ì•„ìš”</a>
      <a class="chip {% if sort == 'comments' %}active{% endif %}" href="?sort=comments">ëŒ“ê¸€</a>
    </div>
    {% for p in posts %}
      <article class="post card" data-post>
        <div class="post-top">
          <a class="post-user" href="{% url 'accounts:profile' p.author.username %}">
            <span class="mini-avatar">
              {% if p.author.profile_pic %}
                <img src="{{ p.author.profile_pic.url }}" alt="profile">
              {% else %}
                <span class="mini-avatar-fallback"></span>
              {% endif %}
            </span>
            <b>{{ p.author.username }}</b>
          </a>
          <span class="muted">{{ p.created_at|date:"m/d H:i" }}</span>
        </div>

        {% if p.images.all %}
          <div class="carousel" data-carousel>
            <button class="carousel-btn prev" type="button" data-prev aria-label="prev">â€¹</button>

            <div class="carousel-viewport" data-viewport>
              {% for img in p.images.all %}
                <img
                  class="carousel-img {% if forloop.first %}is-active{% endif %}"
                  src="{{ img.image.url }}"
                  alt="post image"
                  loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
                  fetchpriority="{% if forloop.first %}high{% else %}auto{% endif %}"
                >
              {% endfor %}

            </div>

            <button class="carousel-btn next" type="button" data-next aria-label="next">â€º</button>

            <div class="carousel-dots" data-dots></div>
          </div>
        {% endif %}


        {% if p.content %}
          <p class="post-content">{{ p.content|linebreaksbr }}</p>
        {% endif %}

        <div class="post-actions">
          <button
            class="like-btn {% if p.liked_by_me %}liked{% endif %}"
            data-like-btn
            data-post-id="{{ p.id }}"
            data-csrf="{{ csrf_token }}"
            type="button"
          >
            ğŸ‘ ì¢‹ì•„ìš”
          </button>
          <span class="muted">ì¢‹ì•„ìš” <b data-like-count>{{ p.like_count }}</b></span>
          <span class="muted">ëŒ“ê¸€ <b>{{ p.comment_count }}</b></span>

          <a class="btn-outline" href="{% url 'posts:post_detail' p.id %}">ìƒì„¸</a>
          {% if p.author_id == user.id %}
            <div class="post-right"></div>
              <a class="btn-outline" href="{% url 'posts:post_edit' p.id %}">ìˆ˜ì •</a>
              <form action="{% url 'posts:post_delete' p.id %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button class="btn-outline danger" type="submit">ì‚­ì œ</button>
              </form>
            </div>
          {% endif %}
        </div>
      </article>
    {% empty %}
      <p class="muted">í”¼ë“œì— ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endfor %}
  </section>
{% endblock %}
